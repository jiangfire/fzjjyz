name: Test and Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  GO_VERSION: '1.25'

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run linter
        run: golangci-lint run --timeout 5m

      - name: Run tests
        run: go test ./... -cover -v

      - name: Run go fmt check
        run: |
          go fmt ./...
          git diff --exit-code || echo "::warning::Code formatting issues found"

      - name: Build
        run: go build -o fzj ./cmd/fzjjyz

      - name: Run help
        run: ./fzj --help

      - name: Run version
        run: ./fzj version

  cross-compile:
    name: Cross-compile
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cross-compile for major platforms
        run: |
          echo "Building for Linux..."
          GOOS=linux GOARCH=amd64 go build -o fzj_linux_amd64 ./cmd/fzjjyz

          echo "Building for Windows..."
          GOOS=windows GOARCH=amd64 go build -o fzj_windows_amd64.exe ./cmd/fzjjyz

          echo "Building for macOS Intel..."
          GOOS=darwin GOARCH=amd64 go build -o fzj_darwin_amd64 ./cmd/fzjjyz

          echo "Building for macOS Apple Silicon..."
          GOOS=darwin GOARCH=arm64 go build -o fzj_darwin_arm64 ./cmd/fzjjyz

          echo "Build completed successfully:"
          ls -lh fzj_*

      - name: Test binaries
        run: |
          # Test Linux binary (should work on Ubuntu runner)
          ./fzj_linux_amd64 version
          ./fzj_linux_amd64 keygen -d /tmp/testkeys -n testkey
          echo "test content" > /tmp/test.txt
          ./fzj_linux_amd64 encrypt -i /tmp/test.txt -o /tmp/test.fzj -p /tmp/testkeys/testkey_public.pem -s /tmp/testkeys/testkey_dilithium_private.pem
          ./fzj_linux_amd64 decrypt -i /tmp/test.fzj -o /tmp/test_recovered.txt -p /tmp/testkeys/testkey_private.pem -s /tmp/testkeys/testkey_dilithium_public.pem
          diff /tmp/test.txt /tmp/test_recovered.txt && echo "âœ… Functional test passed"
          rm -rf /tmp/testkeys /tmp/test.txt /tmp/test.fzj /tmp/test_recovered.txt

  security-audit:
    name: Security Audit
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Run gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -exclude=G115,G304,G305,G110 ./...